import React, { ReactElement } from 'react'
import SettingsMenu from '@components/menus/SettingsMenu';
import ProtectedLayout from '@layouts/ProtectedLayout'
import { NextPageWithLayout } from '@pages/_app'
import { changeUserPasswordMutation } from '@services/graphql/queries/user';
import { RootState } from '@store/configure-store';
import { Button, Col, Form, Input, Row, message } from 'antd';
import Head from 'next/head'
import { useSelector } from 'react-redux';
import { useMutation } from 'urql';
import styles from './SecurityPage.module.less';

const SecurityPage: NextPageWithLayout = () => {
	const [form] = Form.useForm();
	const userId = useSelector((state: RootState) => state.user.id)
	const [, changeUserPassword] = useMutation(changeUserPasswordMutation);

	const handleFinish = async () => {
		const { newPassword, confirmPassword } = form.getFieldsValue();

		if (!newPassword || newPassword !== confirmPassword) {
			message.error('Password mismatch!');
			return;
		}

		try {
			const { error } = await changeUserPassword({
				password: newPassword,
				id: userId,
			});

			if (error) {
				message.error(error.message);
				return;
			}

			message.success('Password changed!');

			form.resetFields();
		} catch (error: any) {
			message.error(error.message);
		}
	}

	return (
		<>
			<Head>
				<title>Security</title>
				<meta
					name="description"
					content="Generated by create next app"
				/>
				<link rel="icon" href="/favicon.ico" />
			</Head>
			<Row>
				<Col>
					<SettingsMenu selectedItem="security" />
				</Col>
				<Col flex="1" className={styles.content}>
					<h3>Security settings</h3>
					<Form
						className={styles.form}
						form={form}
						layout="vertical"
						onFinish={handleFinish}
						requiredMark={false}
					>
						<Form.Item
							name="newPassword"
							rules={[{ required: true, message: 'Please input a new password!' }]}
						>
							<Input.Password placeholder="New password" />
						</Form.Item>
						<Form.Item
							name="confirmPassword"
							rules={[{ required: true, message: 'Please confirm the password!' }]}
						>
							<Input.Password placeholder="Confirm password" />
						</Form.Item>
						<Form.Item>
							<Button
								type="primary"
								htmlType="submit"
								style={{ marginTop: '15px' }}
							>
								Change password
							</Button>
						</Form.Item>
					</Form>
				</Col>
			</Row>
		</>
	)
}

SecurityPage.getLayout = (page: ReactElement) => <ProtectedLayout title="Profile">{page}</ProtectedLayout>;

export default SecurityPage;